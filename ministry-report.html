<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ministry Report • EYIMF</title>
  <link rel="icon" href="assets/favicon.png" />
  <link rel="stylesheet" href="style.css?v=ministry-report-1" />
  <style>
    .report-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    @media print{ .navlinks,.footer,.report-actions{display:none} body{background:#fff} }
  </style>
</head>
<body>
  <nav>
    <div class="container navbar">
      <div class="brand">
        <span class="name">Examine Yourselves International Mission Foundation</span>
      </div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="updates.html">Updates</a>
        <a href="whatwedo.html">What We Do</a>
        <a href="contact.html" class="cta">Contact</a>
      </div>
    </div>
  </nav>

  <main class="section">
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h1>This Week's Ministry Report</h1>
        <div class="report-actions">
          <label for="month-select">Month:</label>
          <input id="month-select" type="month" aria-label="Select month" />
          <button id="btn-load-month">Load</button>
          <button id="btn-print">Print</button>
          <button id="btn-download-csv">Download CSV</button>
        </div>
      </div>

      <div id="report-container">
        <p class="no-report">Loading the latest ministry report…</p>
      </div>

      <p style="margin-top:16px;">
        Manage reports with the <a href="report-editor.html">Report Editor</a>. Reports are read from <code>assets/reports/reports.json</code>.
      </p>
    </div>
  </main>

  <footer class="footer" id="contact">
    <div class="container">
      <div style="display:flex;justify-content:space-between;gap:20px;flex-wrap:wrap;">
        <div><strong>Examine Yourselves International Mission Foundation</strong><br>
          Email: <a href="mailto:info@eyimf.org">info@eyimf.org</a></div>
        <div><div>“Serving souls, meeting needs, glorifying Christ.”</div>
          <div style="margin-top:8px;">KJV — James 2:15–17</div></div>
      </div>
      <div style="margin-top:16px;opacity:.8">© <span id="yr"></span> EYIMF</div>
    </div>
    <script>document.getElementById('yr').textContent=new Date().getFullYear()</script>
  </footer>

<script>
(function(){
  const container = document.getElementById('report-container');
  const monthInput = document.getElementById('month-select');
  const btnLoad = document.getElementById('btn-load-month');
  const btnPrint = document.getElementById('btn-print');
  const btnCSV = document.getElementById('btn-download-csv');

  function monthKeyFromDate(d){ // d: YYYY-MM-DD -> YYYY-MM
    if(!d) return '';
    return d.split('-').slice(0,2).join('-');
  }

  function renderReport(report){
    if(!report){ container.innerHTML = '<p class="no-report">No ministry report found.</p>'; return; }
    const html = `
      <h2>${report.weekLabel || report.date || 'Weekly Report'}</h2>
      <table style="width:100%;max-width:820px;border-collapse:collapse;margin-top:8px;">
        <tbody>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Sunday Adult Service Attendance</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.adultAttendance||0}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Children's Church Attendance</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.childrenAttendance||0}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Teen Outreach Attendance</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.teenAttendance||0}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">New Confessions of Faith</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.confessions||0}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Baptisms</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.baptisms||0}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Food Packs Distributed</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.foodPacks||0}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Financial Donations (USD)</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.donations||'0.00'}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Expenses (USD)</th><td style="padding:8px;border-bottom:1px solid #eee;">${report.expenses||'0.00'}</td></tr>
        </tbody>
      </table>
      <div style="margin-top:12px;"><strong>Notes:</strong><div style="margin-top:6px;">${(report.notes||'').replace(/\n/g,'<br>')||'<em>No additional notes.</em>'}</div></div>
      <p style="margin-top:10px;">${report.expenseDetailsUrl?`<a href="${report.expenseDetailsUrl}" target="_blank" rel="noopener">Detailed expense report</a>`:''}</p>
    `;
    container.innerHTML = html;
  }

  function renderMonth(reports, monthKey){
    // pick the latest report in month or show aggregated month total and list
    const monthReports = reports.filter(r => monthKeyFromDate(r.date) === monthKey);
    if(!monthReports.length){ container.innerHTML = '<p class="no-report">No reports for this month.</p>'; return; }
    // aggregated totals
    const agg = monthReports.reduce((acc,r)=>{
      acc.adultAttendance += parseInt(r.adultAttendance||0,10);
      acc.childrenAttendance += parseInt(r.childrenAttendance||0,10);
      acc.teenAttendance += parseInt(r.teenAttendance||0,10);
      acc.confessions += parseInt(r.confessions||0,10);
      acc.baptisms += parseInt(r.baptisms||0,10);
      acc.foodPacks += parseInt(r.foodPacks||0,10);
      acc.donations = (parseFloat(acc.donations)+parseFloat(r.donations||0)).toFixed(2);
      acc.expenses = (parseFloat(acc.expenses)+parseFloat(r.expenses||0)).toFixed(2);
      return acc;
    }, {adultAttendance:0,childrenAttendance:0,teenAttendance:0,confessions:0,baptisms:0,foodPacks:0,donations:0,expenses:0});

    const rows = monthReports.map(r=>`<li><strong>${r.weekLabel||r.date}</strong> — Adults: ${r.adultAttendance||0}, Children: ${r.childrenAttendance||0}, Food packs: ${r.foodPacks||0}</li>`).join('');

    container.innerHTML = `
      <h2>Monthly Summary — ${monthKey}</h2>
      <table style="width:100%;max-width:820px;border-collapse:collapse;margin-top:8px;">
        <tbody>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Total Adult Attendance</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.adultAttendance}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Total Children's Attendance</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.childrenAttendance}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Total Teen Attendance</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.teenAttendance}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Total New Confessions</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.confessions}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Total Baptisms</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.baptisms}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Food Packs Distributed</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.foodPacks}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Donations (USD)</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.donations}</td></tr>
          <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Expenses (USD)</th><td style="padding:8px;border-bottom:1px solid #eee;">${agg.expenses}</td></tr>
        </tbody>
      </table>
      <div style="margin-top:12px;"><strong>Weekly breakdown:</strong><ul>${rows}</ul></div>
    `;
  }

  function toCSV(reports){
    const keys = ['weekLabel','date','adultAttendance','childrenAttendance','teenAttendance','confessions','baptisms','foodPacks','donations','expenses','notes','expenseDetailsUrl'];
    const lines = [keys.join(',')];
    for(const r of reports){
      const row = keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(',');
      lines.push(row);
    }
    return lines.join('\n');
  }

  function fetchReports(){
    return fetch('assets/reports/reports.json?v=1').then(r=>r.ok? r.json(): []).catch(()=>[]);
  }

  // initial load: latest by date
  fetchReports().then(reports=>{
    if(!Array.isArray(reports) || !reports.length){ container.innerHTML = '<p class="no-report">No reports found in assets/reports/reports.json.</p>'; return; }
    const sorted = reports.slice().sort((a,b)=>(a.date||'') > (b.date||'') ? -1:1);
    renderReport(sorted[0]);
    // set month input to latest report month
    const m = monthKeyFromDate(sorted[0].date);
    if(m){ monthInput.value = m; }
  });

  btnLoad.addEventListener('click', ()=>{
    const m = (monthInput.value||'').slice(0,7); if(!m){ alert('Select a month'); return; }
    fetchReports().then(reports=>{ renderMonth(reports,m); });
  });

  btnPrint.addEventListener('click', ()=>{
    window.print();
  });

  btnCSV.addEventListener('click', ()=>{
    const m = (monthInput.value||'').slice(0,7);
    fetchReports().then(reports=>{
      const filtered = m ? reports.filter(r=>monthKeyFromDate(r.date)===m) : reports;
      if(!filtered.length){ alert('No reports to export for that month.'); return; }
      const csv = toCSV(filtered);
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `reports_${m||'all'}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  });
})();
</script>
</body>
</html>
