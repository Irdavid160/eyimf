<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daily Devotions • EYIMF</title>
  <link rel="icon" href="assets/favicon.png">
  <link rel="stylesheet" href="style.css?v=devotions-1">
</head>
<body>
  <nav>
    <div class="container navbar">
      <div class="brand">
        <span class="name">Examine Yourselves International Mission Foundation</span>
      </div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="whatwedo.html">What We Do</a>
        <a href="updates.html">Updates</a>
        <a href="media.html">Media</a>
        <a href="contact.html" class="cta">Contact</a>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="container devotion-wrap">
      <h1 style="text-align:center;margin-bottom:8px;">Daily Devotions</h1>
      <p style="text-align:center;opacity:.8;margin-top:0">A new reading each day this month.</p>

      <div class="devotion-card card" id="devotionCard" style="max-width:760px;margin:16px auto;">
        <div class="devotion-meta" style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <span class="badge" id="devotionDate"></span>
          <div class="devotion-nav" style="display:flex;gap:8px;">
            <button class="btn" id="prevBtn" aria-label="Previous devotion">← Prev</button>
            <button class="btn" id="todayBtn" aria-label="Today">Today</button>
            <button class="btn" id="nextBtn" aria-label="Next devotion">Next →</button>
          </div>
        </div>

        <h2 id="devotionTitle" style="margin:12px 0 6px;"></h2>
        <div id="devotionScripture" style="font-weight:600;color:var(--color-primary);margin-bottom:10px;"></div>
        <div id="devotionBody" style="line-height:1.7;"></div>

        <div id="devotionShare" style="margin-top:14px;font-size:.9rem;opacity:.85;">
          <a id="permalink" class="text-link" href="#">Permalink to this day</a>
        </div>
      </div>

      <!-- Optional: quick archive for the current month -->
      <details style="max-width:760px;margin:12px auto;">
        <summary><strong>View this month’s list</strong></summary>
        <ul id="devotionList" style="list-style:none;padding:0;margin:10px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;"></ul>
      </details>
    </div>
  </section>

  <footer class="footer" id="contact">
    <div class="container">
      <div style="display:flex;justify-content:space-between;gap:20px;flex-wrap:wrap;">
        <div><strong>Examine Yourselves International Mission Foundation</strong><br>
          Email: <a href="mailto:info@eyimf.org">info@eyimf.org</a></div>
        <div><div>“Serving souls, meeting needs, glorifying Christ.”</div>
          <div style="margin-top:8px;">KJV — James 2:15–17</div></div>
      </div>
      <div style="margin-top:16px;opacity:.8">© <span id="yr"></span> EYIMF</div>
    </div>
    <script>document.getElementById('yr').textContent=new Date().getFullYear()</script>
  </footer>

  <script>
    // --- CONFIG ---
    const JSON_URL = 'assets/devotions/devotions.json?v=1'; // bump v= when you edit

    // Helpers
    const pad = n => String(n).padStart(2, '0');
    const toISODate = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    // Determine which day to show:
    // 1) ?date=YYYY-MM-DD OR ?day=1..31
    // 2) else: today's local date
    function getRequestedDate() {
      const params = new URLSearchParams(location.search);
      if (params.has('date')) {
        const d = new Date(params.get('date'));
        if (!isNaN(d)) return d;
      }
      if (params.has('day')) {
        const today = new Date();
        const day = Math.max(1, Math.min(31, parseInt(params.get('day'),10) || today.getDate()));
        return new Date(today.getFullYear(), today.getMonth(), day);
      }
      return new Date();
    }

    // Load devotions
    let DEVOTIONS = []; // array of entries (see JSON format)
    let currentDate = getRequestedDate();

    async function loadDevotions() {
      const res = await fetch(JSON_URL, {cache:'no-store'});
      DEVOTIONS = await res.json();
      renderForDate(currentDate);
      buildArchive();
      // At local midnight, update automatically if the page is left open
      scheduleMidnightTick();
    }

    function findEntryByDate(d) {
      const iso = toISODate(d);
      // Prefer exact date match
      let entry = DEVOTIONS.find(x => x.date === iso);
      if (entry) return entry;

      // Fallback: pick by day-of-month (1..31)
      const day = d.getDate();
      // If you have fewer than 31 entries, this wraps around
      entry = DEVOTIONS[(day - 1) % DEVOTIONS.length];
      return entry;
    }

    function renderForDate(d) {
      currentDate = d;
      const entry = findEntryByDate(d);
      const dateEl = document.getElementById('devotionDate');
      const titleEl = document.getElementById('devotionTitle');
      const scriptureEl = document.getElementById('devotionScripture');
      const bodyEl = document.getElementById('devotionBody');
      const permalink = document.getElementById('permalink');

      // Render
      const long = d.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
      dateEl.textContent = long;
      titleEl.textContent = entry?.title || 'Devotion';
      scriptureEl.textContent = entry?.scripture || '';
      bodyEl.innerHTML = (entry?.body || '').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>'); // simple paragraphs
      permalink.href = `devotions.html?date=${toISODate(d)}`;
    }

    // Nav
    document.addEventListener('click', (e) => {
      if (e.target.id === 'prevBtn') {
        const d = new Date(currentDate); d.setDate(d.getDate()-1); renderForDate(d);
      } else if (e.target.id === 'nextBtn') {
        const d = new Date(currentDate); d.setDate(d.getDate()+1); renderForDate(d);
      } else if (e.target.id === 'todayBtn') {
        renderForDate(new Date());
      }
    });

    // Archive (list of this month’s days that have entries)
    function buildArchive() {
      const list = document.getElementById('devotionList');
      if (!list) return;
      list.innerHTML = '';
      const today = new Date();
      const y = today.getFullYear(), m = today.getMonth();
      const daysInMonth = new Date(y, m+1, 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(y, m, d);
        const entry = findEntryByDate(date);
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `devotions.html?date=${toISODate(date)}`;
        a.className = 'text-link';
        a.textContent = `${pad(m+1)}/${pad(d)} — ${entry?.title || 'Devotion'}`;
        li.appendChild(a);
        list.appendChild(li);
      }
    }

    function scheduleMidnightTick() {
      const now = new Date();
      const midnight = new Date(now); midnight.setHours(24,0,0,0);
      const ms = midnight - now;
      setTimeout(() => { renderForDate(new Date()); scheduleMidnightTick(); }, ms);
    }

    loadDevotions();
  </script>
</body>
</html>

