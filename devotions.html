<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daily Devotions • EYIMF</title>
  <link rel="icon" href="assets/favicon.png">
  <link rel="stylesheet" href="style.css?v=devotions2">
  <style>
    /* Only affects devotions.html via .devotion-page body class */
.devotion-page .navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.devotion-page .brand {
  font-weight: bold;
  font-size: 2em;           /* Make it large */
  text-align: left;
  white-space: normal;      /* Allow wrapping */
  overflow: visible;        /* Show all text */
  flex: 1;                  /* Take up remaining space */
}

.devotion-page .navlinks {
  display: flex;
  gap: 1.5em;
  flex-shrink: 0;
}

/* small styles for the date and nav above the devotion */
.devotion-meta {
  text-align: center;
  margin-bottom: 12px;
  display: flex;
  justify-content: center;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}
.devotion-meta .devotion-date {
  color: #6e5d48;
  font-style: italic;
  font-weight: 500;
}
.devotion-meta .dev-nav a {
  color: #4b2e05;
  text-decoration: none;
  border-bottom: 1px dashed transparent;
  padding-bottom: 2px;
}
.devotion-meta .dev-nav a:hover {
  border-color: #4b2e05;
}

.devotion-container .no-devotion {
  text-align: center;
  font-style: italic;
  color: #777;
}
  </style>
</head>
<body class="devotion-page">
  <nav>
    <div class="container navbar">
      <div class="brand"><span class="name">Examine Yourselves International Mission Foundation</span></div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="whatwedo.html">What We Do</a>
        <a href="updates.html">Updates</a>
        <a href="media.html">Media</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="container">
     <h1 style="text-align:center;margin-bottom:8px;">Daily Devotion</h1>

     <!-- Minimal meta: Prev / Date / Next (hidden if not applicable) -->
     <div class="devotion-meta" aria-hidden="false">
       <div class="dev-nav">
         <a id="devotion-prev" href="#" style="display:none;">← Previous</a>
       </div>

       <div class="devotion-date" id="devotion-date" aria-live="polite" aria-atomic="true">
         <!-- formatted date will appear here -->
       </div>

       <div class="dev-nav">
         <a id="devotion-next" href="#" style="display:none;">Next →</a>
       </div>
     </div>

      <div id="devotion" class="devotion-container">
        <p class="no-devotion">Loading today's devotion...</p>
      </div>

      <p style="text-align:center;margin-top:10px;">
        <a class="text-link" href="updates.html">← Back to Updates</a>
      </p>
    </div>
  </section>

  <footer class="footer" id="contact">
    <div class="container">
      <div style="display:flex;justify-content:space-between;gap:20px;flex-wrap:wrap;">
        <div><strong>Examine Yourselves International Mission Foundation</strong><br>
          Email: <a href="mailto:info@eyimf.org">info@eyimf.org</a></div>
        <div><div>“Serving souls, meeting needs, glorifying Christ.”</div>
          <div style="margin-top:8px;">KJV — James 2:15–17</div></div>
      </div>
      <div style="margin-top:16px;opacity:.8">© <span id="yr"></span> EYIMF</div>
    </div>
    <script>document.getElementById('yr').textContent=new Date().getFullYear()</script>
  </footer>

  <script>
    // Minimal loader with:
    // - optional ?date=YYYY-MM-DD support
    // - formatted date above the title
    // - Prev / Next navigation (links to same page with ?date=...)
    // - better error messaging in console + visible fallback text

    const JSON_URL = 'assets/devotions/devotions.json?v=1';
    const pad = n => String(n).padStart(2,'0');

    function formatDateISO(iso) {
      try {
        const d = new Date(iso + 'T00:00:00');
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
      } catch (e) { return iso; }
    }

    function getQueryDate() {
      const params = new URLSearchParams(window.location.search);
      const q = params.get('date');
      if (q && /^\d{4}-\d{2}-\d{2}$/.test(q)) return q;
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Fetch and be resilient about bad JSON: show friendly message and log response text
    fetch(JSON_URL, {cache:'no-store'})
      .then(async r => {
        if (!r.ok) {
          throw new Error('Network error: ' + r.status + ' ' + r.statusText);
        }
        const text = await r.text();
        try {
          return JSON.parse(text);
        } catch (parseErr) {
          console.error('devotions JSON parse error:', parseErr);
          console.log('devotions JSON response (raw):', text);
          // try to give the user a helpful message on the page
          document.getElementById('devotion').innerHTML =
            `<p class="no-devotion">Devotions file could not be parsed. Please check assets/devotions/devotions.json (invalid JSON).</p>`;
          // still throw so the catch below can also run
          throw parseErr;
        }
      })
      .then(devs => {
        if (!Array.isArray(devs) || devs.length === 0) {
          document.getElementById('devotion').innerHTML = `<p class="no-devotion">No devotions available.</p>`;
          document.getElementById('devotion-date').textContent = formatDateISO(getQueryDate());
          return;
        }

        // normalize & sort ascending
        devs.sort((a,b)=> (a.date||'').localeCompare(b.date||''));

        const requestedDate = getQueryDate();
        let idx = devs.findIndex(x => x.date === requestedDate);

        // fallback: if requested not found, try today, otherwise last entry
        if (idx === -1) {
          const todayISO = (new Date()).toISOString().split('T')[0];
          idx = devs.findIndex(x => x.date === todayISO);
          if (idx === -1) idx = Math.max(0, devs.length - 1);
        }

        const d = devs[idx];
        const el = document.getElementById('devotion');
        const dateEl = document.getElementById('devotion-date');

        if (!d) {
          el.innerHTML = '<p class="no-devotion">No devotion available.</p>';
          dateEl.textContent = '';
          return;
        }

        dateEl.textContent = formatDateISO(d.date || requestedDate);

        const bodyHtml = (d.body || '')
          .replace(/\r/g,'')
          .replace(/\n/g, '<br>')
          .split(/<br>\s*<br>/)
          .map(p => `<p>${p.trim()}</p>`)
          .join('');

        el.innerHTML = `
          <h2>${d.title || 'Devotion'}</h2>
          <div class="scripture">${d.scripture || ''}</div>
          ${bodyHtml}
        `;
        el.classList.add('loaded');

        const prevLink = document.getElementById('devotion-prev');
        const nextLink = document.getElementById('devotion-next');

        if (idx > 0) {
          prevLink.style.display = 'inline';
          prevLink.href = `devotions.html?date=${devs[idx-1].date}`;
          prevLink.title = devs[idx-1].title || devs[idx-1].date;
        } else {
          prevLink.style.display = 'none';
        }

        if (idx < devs.length - 1) {
          nextLink.style.display = 'inline';
          nextLink.href = `devotions.html?date=${devs[idx+1].date}`;
          nextLink.title = devs[idx+1].title || devs[idx+1].date;
        } else {
          nextLink.style.display = 'none';
        }
      })
      .catch(err => {
        // if an earlier parse/network error happened, we already wrote a friendly message in some cases.
        console.error('Error loading devotions:', err);
        const el = document.getElementById('devotion');
        if (!el.innerHTML || el.innerHTML.indexOf('No devotions') === -1) {
          el.innerHTML = '<p class="no-devotion">Unable to load devotions. See console for details.</p>';
        }
        // show the requested date anyway
        const dateEl = document.getElementById('devotion-date');
        dateEl.textContent = formatDateISO(getQueryDate());
        document.getElementById('devotion-prev').style.display = 'none';
        document.getElementById('devotion-next').style.display = 'none';
      });
  </script>
</body>
</html>
